# **16. Task Scheduling & Jobs in Laravel**  

Laravel provides a built-in **task scheduling** feature using **cron jobs** and a **queue system** to handle background tasks efficiently.  

---

## **1. Task Scheduling in Laravel**  

Laravel's task scheduler allows you to **automate repetitive tasks** without manually setting up cron jobs for each.  

### **Step 1: Define Scheduled Tasks in `app/Console/Kernel.php`**  
```php
protected function schedule(Schedule $schedule)
{
    // Run daily at midnight
    $schedule->command('emails:send')->daily();

    // Run every 15 minutes
    $schedule->command('backup:run')->everyFifteenMinutes();

    // Run every Monday at 8 AM
    $schedule->call(function () {
        \Log::info('Weekly report generated');
    })->weeklyOn(1, '08:00');

    // Run a task if another one succeeds
    $schedule->command('reports:generate')->daily()->then(function () {
        \Log::info('Report generated successfully');
    });
}
```

---

## **2. Running the Laravel Scheduler**  

Laravel's scheduler requires a **single cron job** to be set up on the server:  
```bash
* * * * * php /path-to-your-project/artisan schedule:run >> /dev/null 2>&1
```
This runs every minute and executes any due tasks.

---

## **3. Common Task Scheduling Methods**  

| Method | Description |
|--------|------------|
| `->daily()` | Runs once a day at midnight |
| `->hourly()` | Runs every hour |
| `->everyMinute()` | Runs every minute |
| `->everyFiveMinutes()` | Runs every 5 minutes |
| `->weeklyOn($day, $time)` | Runs on a specific day and time |
| `->monthly()` | Runs on the first day of the month |
| `->yearly()` | Runs once a year |
| `->timezone('Asia/Kolkata')` | Sets the timezone for execution |

---

## **4. Background Jobs & Queues in Laravel**  

Queues in Laravel allow you to **defer time-consuming tasks**, improving **performance and user experience**.

### **Step 1: Configure Queue Driver in `.env`**  
```env
QUEUE_CONNECTION=database
```
Other options: `redis`, `sync`, `sqs`, `beanstalkd`, etc.

### **Step 2: Create a Job Class**  
```bash
php artisan make:job SendEmailJob
```
This creates `app/Jobs/SendEmailJob.php`.

### **Step 3: Define the Job Logic**  
Modify `SendEmailJob.php`:
```php
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldBeUnique;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;
use Mail;

class SendEmailJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    protected $user;

    public function __construct($user)
    {
        $this->user = $user;
    }

    public function handle()
    {
        Mail::to($this->user->email)->send(new \App\Mail\WelcomeEmail($this->user));
    }
}
```

### **Step 4: Dispatch the Job**  
```php
use App\Jobs\SendEmailJob;

$user = User::find(1);
dispatch(new SendEmailJob($user));
```

### **Step 5: Running the Queue Worker**  
Run the following command to process jobs:  
```bash
php artisan queue:work
```

---

## **5. Managing Failed Jobs**  

### **Storing Failed Jobs**  
Enable failed job tracking in `.env`:  
```env
QUEUE_CONNECTION=database
```
Then, create the failed jobs table:  
```bash
php artisan queue:failed-table
php artisan migrate
```

### **Retrying Failed Jobs**  
```bash
php artisan queue:retry all
```

### **Clearing Failed Jobs**  
```bash
php artisan queue:flush
```

---

## **6. Dispatching Jobs with Delay & Batch Processing**  

### **Delayed Jobs**  
```php
dispatch(new SendEmailJob($user))->delay(now()->addMinutes(10));
```

### **Batch Jobs (Running Multiple Jobs Together)**  
```php
use Illuminate\Bus\Batch;
use Illuminate\Support\Facades\Bus;
use App\Jobs\SendEmailJob;

Bus::batch([
    new SendEmailJob($user1),
    new SendEmailJob($user2),
    new SendEmailJob($user3),
])->dispatch();
```

---

## **7. Event-Driven Job Handling**  

Jobs can be dispatched **after an event occurs**.  
Example: Send an email when a user registers.

### **Step 1: Create an Event**  
```bash
php artisan make:event UserRegistered
```
Modify `UserRegistered.php`:
```php
class UserRegistered
{
    use Dispatchable, SerializesModels;
    public $user;
    
    public function __construct($user)
    {
        $this->user = $user;
    }
}
```

### **Step 2: Create a Listener**  
```bash
php artisan make:listener SendWelcomeEmail --event=UserRegistered
```
Modify `SendWelcomeEmail.php`:
```php
use App\Jobs\SendEmailJob;

class SendWelcomeEmail
{
    public function handle(UserRegistered $event)
    {
        dispatch(new SendEmailJob($event->user));
    }
}
```

### **Step 3: Register Event & Listener in `EventServiceProvider.php`**
```php
protected $listen = [
    UserRegistered::class => [
        SendWelcomeEmail::class,
    ],
];
```

### **Step 4: Fire Event in Controller**
```php
use App\Events\UserRegistered;

$user = User::create($request->all());
event(new UserRegistered($user));
```

---

## **8. Best Practices for Scheduling & Queues**  

✅ **Use queues for heavy tasks** (email sending, report generation).  
✅ **Prioritize queue jobs** using multiple workers and queues.  
✅ **Monitor queue workers** using **Supervisor** in production.  
✅ **Use database or Redis queues** instead of the default `sync` driver.  
✅ **Schedule cron jobs only once per minute** to avoid duplication.  
✅ **Handle job failures properly** and log errors.  

---

## **9. Common Interview Questions on Laravel Jobs & Scheduling**  

1. How does Laravel’s **task scheduler** work?  
2. How do you **run a cron job** in Laravel?  
3. What is the purpose of the `schedule:run` command?  
4. What are the different ways to **schedule tasks** in Laravel?  
5. What is Laravel’s **queue system**, and why is it used?  
6. How do you configure **queue drivers** in Laravel?  
7. What is the difference between `queue:work` and `queue:listen`?  
8. How do you **retry failed jobs** in Laravel?  
9. How do you dispatch a **delayed job**?  
10. What are **batch jobs** in Laravel, and how do you use them?  

---
