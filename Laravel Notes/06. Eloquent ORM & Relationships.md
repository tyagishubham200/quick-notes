# **6. Eloquent ORM & Relationships**  

## **What is Eloquent ORM?**  
Eloquent is Laravelâ€™s built-in **Object-Relational Mapper (ORM)**, which allows developers to interact with the database using an expressive and fluent syntax instead of writing raw SQL queries.

### **Creating an Eloquent Model**  
```sh
php artisan make:model User
```
This creates `app/Models/User.php`, which represents the `users` table.

### **Creating a Model with Migration**  
```sh
php artisan make:model Post -m
```
- `-m` flag creates a migration file in `database/migrations/`.
- You can define the table structure inside the migration file and run:
  ```sh
  php artisan migrate
  ```

---

## **Basic Eloquent Methods**  

### **Retrieving Data**
```php
use App\Models\User;

// Get all users
$users = User::all();

// Get a user by ID
$user = User::find(1);

// Get first record matching a condition
$user = User::where('email', 'test@example.com')->first();
```

### **Inserting Data**
```php
$user = new User();
$user->name = "John Doe";
$user->email = "john@example.com";
$user->save();
```
Or using `create()` (requires `$fillable` in the model):
```php
User::create([
    'name' => 'Jane Doe',
    'email' => 'jane@example.com'
]);
```

### **Updating Data**
```php
$user = User::find(1);
$user->name = "Updated Name";
$user->save();
```
Or using `update()`:
```php
User::where('id', 1)->update(['name' => 'Updated Name']);
```

### **Deleting Data**
```php
$user = User::find(1);
$user->delete();
```
Or using `destroy()`:
```php
User::destroy(1);
User::destroy([1, 2, 3]); // Delete multiple
```

---

## **Eloquent Relationships**  
Eloquent makes it easy to define relationships between models.

### **1. One-to-One Relationship**
Example: A `User` has one `Profile`.
- **User Model**
  ```php
  public function profile()
  {
      return $this->hasOne(Profile::class);
  }
  ```
- **Profile Model**
  ```php
  public function user()
  {
      return $this->belongsTo(User::class);
  }
  ```
- **Usage**
  ```php
  $user = User::find(1);
  $profile = $user->profile;
  ```

---

### **2. One-to-Many Relationship**
Example: A `Post` has many `Comments`.
- **Post Model**
  ```php
  public function comments()
  {
      return $this->hasMany(Comment::class);
  }
  ```
- **Comment Model**
  ```php
  public function post()
  {
      return $this->belongsTo(Post::class);
  }
  ```
- **Usage**
  ```php
  $post = Post::find(1);
  $comments = $post->comments;
  ```

---

### **3. Many-to-Many Relationship**
Example: A `User` can have many `Roles`, and a `Role` can belong to many `Users`.
- **User Model**
  ```php
  public function roles()
  {
      return $this->belongsToMany(Role::class);
  }
  ```
- **Role Model**
  ```php
  public function users()
  {
      return $this->belongsToMany(User::class);
  }
  ```
- **Pivot Table (Migration)**
  ```php
  Schema::create('role_user', function (Blueprint $table) {
      $table->id();
      $table->foreignId('user_id')->constrained()->onDelete('cascade');
      $table->foreignId('role_id')->constrained()->onDelete('cascade');
      $table->timestamps();
  });
  ```
- **Usage**
  ```php
  $user = User::find(1);
  $roles = $user->roles; // Get user roles
  ```

---

### **4. Has Many Through**
Example: A `Country` has many `Posts` through `Users` (Country â†’ Users â†’ Posts).
- **Country Model**
  ```php
  public function posts()
  {
      return $this->hasManyThrough(Post::class, User::class);
  }
  ```
- **Usage**
  ```php
  $country = Country::find(1);
  $posts = $country->posts;
  ```

---

## **Eloquent Accessors & Mutators**  

### **Accessors (Modify Output)**
```php
public function getFullNameAttribute()
{
    return $this->first_name . ' ' . $this->last_name;
}
```
Usage:
```php
$user = User::find(1);
echo $user->full_name; // Automatically calls getFullNameAttribute()
```

### **Mutators (Modify Input)**
```php
public function setPasswordAttribute($value)
{
    $this->attributes['password'] = bcrypt($value);
}
```
Usage:
```php
$user->password = 'plainpassword'; // Automatically hashed
$user->save();
```

---

## **Eager Loading vs Lazy Loading**  

### **Lazy Loading (Default)**
```php
$users = User::all();
foreach ($users as $user) {
    echo $user->profile->bio; // Additional query for each user
}
```
âš ï¸ This results in **N+1 query problem**.

### **Eager Loading**
```php
$users = User::with('profile')->get();
foreach ($users as $user) {
    echo $user->profile->bio; // Only 2 queries
}
```
Eager loading avoids the **N+1 query problem** by reducing queries.

---

## **Soft Deletes**
Soft deletes allow "deleting" records without actually removing them from the database.
```sh
php artisan make:migration add_deleted_at_to_users --table=users
```
Modify the migration:
```php
Schema::table('users', function (Blueprint $table) {
    $table->softDeletes();
});
```
Enable it in the model:
```php
use Illuminate\Database\Eloquent\SoftDeletes;

class User extends Model
{
    use SoftDeletes;
}
```
- **Usage**
  ```php
  User::find(1)->delete(); // Moves to 'deleted_at'
  User::withTrashed()->get(); // Fetch all, including soft-deleted
  User::onlyTrashed()->get(); // Fetch only soft-deleted
  User::find(1)->restore(); // Restore deleted record
  ```

---

## **Key Interview Questions on Eloquent ORM & Relationships**  
1. What is **Eloquent ORM**, and why is it used?  
2. What is the difference between **Eloquent and Query Builder**?  
3. Explain **One-to-One, One-to-Many, and Many-to-Many relationships** with examples.  
4. What is **lazy loading vs eager loading**? Why is eager loading preferred?  
5. How do you use **accessors and mutators** in Eloquent models?  
6. How does **soft deleting** work in Laravel?  
7. How do you use **hasManyThrough relationships**?  
8. What are **pivot tables**, and how do they work in many-to-many relationships?  

---

## **1ï¸âƒ£ What is Eloquent ORM, and why is it used?**  
### âœ… **Answer:**  
Eloquent is **Laravel's built-in ORM (Object-Relational Mapping)** that simplifies database interactions by allowing you to work with **models instead of raw SQL queries**.  

âœ” **Why use Eloquent?**  
- **Readable & maintainable** â€“ Queries look like PHP, not SQL.  
- **Automatic timestamps** â€“ Handles `created_at` & `updated_at`.  
- **Relationship management** â€“ Easy to define & retrieve related data.  

#### ðŸ”¹ **Example: Retrieving Users** (Instead of SQL)  
ðŸš« **Without Eloquent (Using SQL)**  
```php
$users = DB::select('SELECT * FROM users WHERE status = ?', [1]);
```
âœ… **With Eloquent**  
```php
$users = User::where('status', 1)->get();
```
âœ” **Shorter, easier, and more readable!**

---

## **2ï¸âƒ£ What is the difference between Eloquent and Query Builder?**  
| Feature | **Eloquent ORM** | **Query Builder** |
|---------|-----------------|-------------------|
| **Usage** | Works with models (OOP) | Works with database tables directly |
| **Readability** | More readable, structured | Requires manual query handling |
| **Performance** | Slightly slower (due to abstraction) | Faster (direct SQL execution) |
| **Relationships** | Built-in relationships | No relationship handling |
| **Example (Fetching Users)** | `User::where('status', 1)->get();` | `DB::table('users')->where('status', 1)->get();` |

âœ” **Use Eloquent for structured models** and **Query Builder for complex queries or performance-sensitive operations**.

---

## **3ï¸âƒ£ Explain One-to-One, One-to-Many, and Many-to-Many relationships with examples.**  
### âœ… **One-to-One**  
Each user has **one** profile.  

#### ðŸ”¹ **Example: Define in `User.php` model**
```php
class User extends Model
{
    public function profile()
    {
        return $this->hasOne(Profile::class);
    }
}
```
#### ðŸ”¹ **Usage**
```php
$user = User::find(1);
$profile = $user->profile;
```

---

### âœ… **One-to-Many**  
One user has **many** posts.  

#### ðŸ”¹ **Define in `User.php` model**
```php
class User extends Model
{
    public function posts()
    {
        return $this->hasMany(Post::class);
    }
}
```
#### ðŸ”¹ **Usage**
```php
$user = User::find(1);
$posts = $user->posts; // Returns multiple posts
```

---

### âœ… **Many-to-Many**  
A student can enroll in **many** courses, and a course can have **many** students.  

#### ðŸ”¹ **Define in `Student.php` model**
```php
class Student extends Model
{
    public function courses()
    {
        return $this->belongsToMany(Course::class);
    }
}
```
#### ðŸ”¹ **Usage**
```php
$student = Student::find(1);
$courses = $student->courses; // Retrieves courses enrolled by student
```
âœ” **Requires a pivot table (e.g., `course_student`)**.

---

## **4ï¸âƒ£ What is lazy loading vs. eager loading? Why is eager loading preferred?**  
| **Loading Type** | **Definition** | **Performance** |
|-----------------|--------------|----------------|
| **Lazy Loading** | Loads relationships **only when accessed**. | **Slow** (many queries) |
| **Eager Loading** | Loads relationships **in advance** using `with()`. | **Faster** (optimized queries) |

### âœ… **Example: Lazy Loading (Multiple Queries)**
```php
$users = User::all();
foreach ($users as $user) {
    echo $user->posts; // Fetching posts for each user (N+1 queries)
}
```
âœ” **Problem?** If 100 users, **101 queries** are executed (1 for users + 100 for posts)!  

### âœ… **Eager Loading (Single Query)**
```php
$users = User::with('posts')->get();
```
âœ” **Only 1 query** instead of 101! ðŸš€

---

## **5ï¸âƒ£ How do you use accessors and mutators in Eloquent models?**  
### âœ… **Accessors (Get Data in Custom Format)**  
Example: Get **uppercase** name.  
```php
class User extends Model
{
    public function getNameAttribute($value)
    {
        return strtoupper($value);
    }
}
```
âœ” Now `User::find(1)->name;` returns **uppercase** name.

---

### âœ… **Mutators (Modify Data Before Saving)**  
Example: Store **password as a hash**.  
```php
class User extends Model
{
    public function setPasswordAttribute($value)
    {
        $this->attributes['password'] = bcrypt($value);
    }
}
```
âœ” Now `$user->password = 'mypassword';` automatically hashes the password.

---

## **6ï¸âƒ£ How does soft deleting work in Laravel?**  
âœ” **Soft deletes allow "deleting" records without actually removing them from the database.**  

### âœ… **Enable Soft Deletes in Model**
```php
use Illuminate\Database\Eloquent\SoftDeletes;

class User extends Model
{
    use SoftDeletes;
}
```
âœ” Adds a `deleted_at` column, instead of removing the record.

### âœ… **Use Soft Deletes**
```php
User::find(1)->delete(); // Sets deleted_at, doesn't delete the row
User::withTrashed()->get(); // Retrieves all users, including soft-deleted ones
User::onlyTrashed()->get(); // Retrieves only soft-deleted users
User::find(1)->restore(); // Restores the user
User::find(1)->forceDelete(); // Permanently deletes the user
```
âœ” Great for **recovery** and **audit tracking**.

---

## **7ï¸âƒ£ How do you use `hasManyThrough` relationships?**  
âœ” Used for **indirect** relationships. Example: A country has **many posts** through **users**.

### âœ… **Example**
- **Country has many users**
- **User has many posts**
- **Country â†’ Users â†’ Posts**

#### ðŸ”¹ **Define in `Country.php` Model**
```php
class Country extends Model
{
    public function posts()
    {
        return $this->hasManyThrough(Post::class, User::class);
    }
}
```
#### ðŸ”¹ **Usage**
```php
$country = Country::find(1);
$posts = $country->posts;
```
âœ” Fetches **all posts from users of a country**.

---

## **8ï¸âƒ£ What are pivot tables, and how do they work in many-to-many relationships?**  
âœ” A pivot table is a **join table** for **many-to-many relationships**.  

### âœ… **Example: Students & Courses (Pivot Table: `course_student`)**
```php
class Student extends Model
{
    public function courses()
    {
        return $this->belongsToMany(Course::class);
    }
}
```
âœ” Laravel assumes pivot table name as **`course_student`** (alphabetical order).  

### âœ… **Adding Extra Columns to Pivot Table**  
Pivot tables can have extra columns like `grade`, `enrolled_at`.  

#### ðŸ”¹ **Define in Model**
```php
class Student extends Model
{
    public function courses()
    {
        return $this->belongsToMany(Course::class)->withPivot('grade', 'enrolled_at');
    }
}
```
#### ðŸ”¹ **Insert Data into Pivot Table**
```php
$student->courses()->attach($courseId, ['grade' => 'A', 'enrolled_at' => now()]);
```
#### ðŸ”¹ **Retrieve Pivot Data**
```php
foreach ($student->courses as $course) {
    echo $course->pivot->grade; 
}
```
âœ” **Pivot tables enable rich many-to-many relationships**.

---

## **Final Summary**
| Question | Key Takeaway |
|----------|-------------|
| **What is Eloquent?** | Laravel's ORM for working with models. |
| **Eloquent vs Query Builder?** | Eloquent = models, Query Builder = raw queries. |
| **Relationships (1-1, 1-M, M-M)?** | Define using `hasOne()`, `hasMany()`, `belongsToMany()`. |
| **Lazy vs Eager Loading?** | Eager loading (`with()`) avoids N+1 query problem. |
| **Accessors & Mutators?** | Modify data on retrieval (`getNameAttribute`) or before saving (`setPasswordAttribute`). |
| **Soft Deletes?** | Use `SoftDeletes` trait to mark records as deleted without removing them. |
| **HasManyThrough?** | Indirect relation (`Country -> Users -> Posts`). |
| **Pivot Tables?** | Join tables for many-to-many relationships. |

ðŸš€ Let me know if you need more details!