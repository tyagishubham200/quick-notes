# **19. Multi-Tenancy & SaaS Development in Laravel**  

Multi-tenancy is a key architectural pattern for **Software as a Service (SaaS) applications**, allowing multiple customers (tenants) to use a single application while keeping their data isolated. Laravel provides various strategies for implementing multi-tenancy.  

---

## **1. What is Multi-Tenancy?**  
Multi-tenancy refers to an architecture where **multiple tenants (clients, businesses, or users) share the same application** but have isolated data.  

### **Types of Multi-Tenancy in Laravel**  
1. **Single Database, Shared Schema** (Row-based Isolation)  
   - All tenants share the same database, but each tenant has an `tenant_id` column for data separation.  
   - **Best for** small to medium SaaS apps.  
2. **Single Database, Multiple Schemas**  
   - Each tenant gets a separate schema inside the same database.  
   - **Best for** applications that require strong data isolation.  
3. **Multiple Databases (Database-per-Tenant)**  
   - Each tenant has a completely separate database.  
   - **Best for** large-scale SaaS applications with high data security needs.  

---

## **2. Implementing Multi-Tenancy in Laravel**  

### **Method 1: Single Database, Shared Schema**  

#### **Step 1: Add a `tenant_id` Column to All Tables**  
```php
Schema::table('users', function (Blueprint $table) {
    $table->unsignedBigInteger('tenant_id')->after('id');
    $table->foreign('tenant_id')->references('id')->on('tenants')->onDelete('cascade');
});
```

#### **Step 2: Use Global Scope to Filter Data by Tenant**  
```php
namespace App\Models;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;

class User extends Model
{
    protected static function booted()
    {
        static::addGlobalScope('tenant', function (Builder $builder) {
            $builder->where('tenant_id', auth()->user()->tenant_id);
        });
    }
}
```

#### **Step 3: Middleware to Set Tenant Context**  
```php
namespace App\Http\Middleware;

use Closure;

class TenantMiddleware
{
    public function handle($request, Closure $next)
    {
        if (auth()->check()) {
            app()->instance('tenant_id', auth()->user()->tenant_id);
        }
        return $next($request);
    }
}
```

Register in `Kernel.php`:  
```php
protected $middleware = [
    \App\Http\Middleware\TenantMiddleware::class,
];
```

---

### **Method 2: Multiple Databases (Database per Tenant)**  

#### **Step 1: Create a Dynamic Database Connection for Each Tenant**  
Modify `config/database.php`:  
```php
'tenant' => [
    'driver' => 'mysql',
    'host' => env('DB_HOST'),
    'database' => null,
    'username' => env('DB_USERNAME'),
    'password' => env('DB_PASSWORD'),
],
```

#### **Step 2: Switch Database Connection at Runtime**  
```php
namespace App\Services;

use Illuminate\Support\Facades\DB;

class TenantDatabase
{
    public static function setConnection($databaseName)
    {
        config(['database.connections.tenant.database' => $databaseName]);
        DB::purge('tenant');
        DB::reconnect('tenant');
    }
}
```

#### **Step 3: Automatically Switch Connection for Each Tenant**  
```php
namespace App\Http\Middleware;

use Closure;
use App\Services\TenantDatabase;

class TenantDatabaseMiddleware
{
    public function handle($request, Closure $next)
    {
        if (auth()->check()) {
            TenantDatabase::setConnection(auth()->user()->tenant->database_name);
        }
        return $next($request);
    }
}
```

---

## **3. Handling Multi-Tenant Authentication**  

#### **Option 1: Separate Login Pages for Each Tenant**  
Redirect users to `tenant.example.com/login` instead of a shared login page.

#### **Option 2: Custom Guard for Multi-Tenant Authentication**  
Define a new guard in `config/auth.php`:
```php
'guards' => [
    'tenant' => [
        'driver' => 'session',
        'provider' => 'users',
    ],
],
```

Use it in authentication:  
```php
Auth::guard('tenant')->attempt($credentials);
```

---

## **4. Multi-Tenant Routing & Subdomains**  

### **Step 1: Configure Subdomain Routing**  
Modify `routes/web.php`:
```php
Route::domain('{tenant}.example.com')->group(function () {
    Route::get('/', [TenantController::class, 'index']);
});
```

### **Step 2: Detect Tenant from Subdomain**  
```php
namespace App\Http\Middleware;

use Closure;
use App\Models\Tenant;

class IdentifyTenant
{
    public function handle($request, Closure $next)
    {
        $tenant = Tenant::where('subdomain', request()->route('tenant'))->first();
        if ($tenant) {
            app()->instance('tenant', $tenant);
        } else {
            abort(404);
        }
        return $next($request);
    }
}
```

---

## **5. Best Practices for Multi-Tenancy in Laravel**  
✅ **Use Global Scopes** to automatically filter data by tenant.  
✅ **Optimize Queries** – Index `tenant_id` to improve database performance.  
✅ **Secure Tenant Data** – Prevent cross-tenant data leakage.  
✅ **Automate Database Provisioning** – Create new databases dynamically when tenants register.  
✅ **Use SaaS Billing** – Integrate **Stripe, Paddle, or Braintree** for tenant subscriptions.  

---

## **6. Common Interview Questions on Multi-Tenancy & SaaS Development**  

### **Multi-Tenancy Questions**  
1. What are the different types of multi-tenancy architectures?  
2. How do you isolate tenant data in a shared database?  
3. What is the role of middleware in multi-tenancy?  
4. How do you dynamically switch database connections in Laravel?  
5. How do you implement subdomain-based multi-tenancy in Laravel?  

### **SaaS Development Questions**  
6. What are the challenges of scaling a SaaS application?  
7. How do you handle user authentication in a SaaS application?  
8. How do you manage SaaS billing and subscriptions?  
9. What are the advantages of using Laravel for SaaS applications?  
10. How do you prevent one tenant from accessing another tenant’s data?  

---
