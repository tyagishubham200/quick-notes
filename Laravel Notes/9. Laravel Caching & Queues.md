# **9. Laravel Caching & Queues**  

## **1. Introduction to Caching in Laravel**  
Caching is a technique used to store frequently accessed data temporarily to reduce database queries and improve application performance. Laravel provides various cache drivers, including **file**, **database**, **Redis**, **Memcached**, and **APC**.  

### **Enabling Cache Configuration**  
The cache configuration file is located at:  
`config/cache.php`  

To set the default cache driver, update the `.env` file:  
```env
CACHE_DRIVER=file
```
Other available options: `redis`, `memcached`, `database`, `array`, `apc`, `dynamodb`, `octane`

---

## **2. Storing and Retrieving Cache Data**  

### **Basic Cache Usage**  
```php
use Illuminate\Support\Facades\Cache;

// Store data in cache
Cache::put('key', 'value', 600); // 600 seconds (10 minutes)

// Retrieve cached data
$value = Cache::get('key');

// Retrieve and provide a default value if not found
$value = Cache::get('key', 'default_value');

// Remove data from cache
Cache::forget('key');
```

---

### **Using Cache Forever (Without Expiry)**  
```php
Cache::forever('site_name', 'My Website');
```

---

### **Checking if a Cache Key Exists**  
```php
if (Cache::has('key')) {
    echo "Cache exists!";
}
```

---

### **Using Cache::remember() to Store and Retrieve**  
```php
$users = Cache::remember('users', 600, function () {
    return DB::table('users')->get();
});
```
This checks if the data exists in the cache. If not, it executes the callback function and caches the result.

---

### **Using Cache::rememberForever() for Permanent Cache**  
```php
$settings = Cache::rememberForever('settings', function () {
    return DB::table('settings')->get();
});
```

---

## **3. Cache Drivers in Laravel**  
### **File-Based Cache (Default)**
Stored in `storage/framework/cache`. Suitable for small projects.  
```env
CACHE_DRIVER=file
```

### **Database Cache (For Large Applications)**
```env
CACHE_DRIVER=database
```
First, create a cache table:  
```bash
php artisan cache:table
php artisan migrate
```

### **Redis (High Performance)**
```env
CACHE_DRIVER=redis
```
Ensure Redis is installed and configure `config/database.php`.

### **Memcached (Distributed Caching)**
```env
CACHE_DRIVER=memcached
```
Useful for applications with multiple servers.

---

## **4. Clearing Cache**  
```bash
php artisan cache:clear     # Clears all cache
php artisan config:clear    # Clears configuration cache
php artisan route:clear     # Clears route cache
php artisan view:clear      # Clears compiled views
```

---

# **Queues in Laravel**  
Queues allow you to handle time-consuming tasks asynchronously, improving performance and user experience.  

## **1. Setting Up Laravel Queues**  
Define the queue driver in the `.env` file:  
```env
QUEUE_CONNECTION=database
```
Other options: `sync`, `redis`, `beanstalkd`, `sqs`, `database`

---

## **2. Creating a Queue Job**  
```bash
php artisan make:job SendEmailJob
```
This generates `app/Jobs/SendEmailJob.php`.

---

## **3. Defining the Job Logic**  
Modify the `handle` method in the job file:  
```php
namespace App\Jobs;

use Mail;
use App\Mail\WelcomeMail;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldBeUnique;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;

class SendEmailJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    protected $user;

    public function __construct($user)
    {
        $this->user = $user;
    }

    public function handle()
    {
        Mail::to($this->user->email)->send(new WelcomeMail($this->user));
    }
}
```
---

## **4. Dispatching the Job**  
From a controller or service:  
```php
use App\Jobs\SendEmailJob;
use App\Models\User;

$user = User::find(1);
dispatch(new SendEmailJob($user));
```
OR  
```php
SendEmailJob::dispatch($user)->delay(now()->addMinutes(5));
```

---

## **5. Running Queue Workers**  
If using the database queue driver, create the jobs table:  
```bash
php artisan queue:table
php artisan migrate
```

Then start processing the jobs:  
```bash
php artisan queue:work
```

To run it in the background with **Supervisor** (for production), configure:  
```bash
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path-to-project/artisan queue:work --tries=3
autostart=true
autorestart=true
numprocs=5
redirect_stderr=true
stdout_logfile=/var/log/worker.log
```
Restart Supervisor:  
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start laravel-worker:*
```

---

## **6. Handling Failed Jobs**  
Laravel provides a way to monitor and retry failed jobs.

### **Tracking Failed Jobs**  
Run the migration for failed jobs:  
```bash
php artisan queue:failed-table
php artisan migrate
```

### **Viewing Failed Jobs**  
```bash
php artisan queue:failed
```

### **Retrying Failed Jobs**  
```bash
php artisan queue:retry all
```

### **Clearing Failed Jobs**  
```bash
php artisan queue:flush
```

---

## **7. Job Batching (Multiple Jobs Together)**  
```php
use Illuminate\Bus\Batch;
use Illuminate\Support\Facades\Bus;
use App\Jobs\SendEmailJob;
use App\Models\User;

Bus::batch([
    new SendEmailJob(User::find(1)),
    new SendEmailJob(User::find(2)),
    new SendEmailJob(User::find(3))
])->dispatch();
```
This runs all jobs together.

---

## **8. Queue Prioritization**  
Laravel allows you to assign priorities to jobs.  
```php
dispatch(new SendEmailJob($user))->onQueue('high');
```
Run workers with different priority levels:  
```bash
php artisan queue:work --queue=high,low
```
This executes high-priority tasks first.

---

## **9. Key Interview Questions on Laravel Caching & Queues**  

### **Caching Questions**  
1. What are different cache drivers available in Laravel?  
2. How do you store and retrieve data from the cache?  
3. What is the difference between `Cache::remember()` and `Cache::rememberForever()`?  
4. How do you configure Redis cache in Laravel?  
5. How do you clear different types of caches in Laravel?  
6. What are the benefits of caching?  
7. What is the difference between `CACHE_DRIVER=file` and `CACHE_DRIVER=database`?

### **Queues Questions**  
8. What is a queue in Laravel, and why is it used?  
9. How do you implement job queues in Laravel?  
10. What is the difference between `dispatch()` and `dispatchNow()`?  
11. How do you retry failed jobs in Laravel queues?  
12. How do you prioritize jobs in Laravel queues?  
13. What is the difference between `queue:work` and `queue:listen`?  
14. How do you configure Supervisor for Laravel queues?  
15. What is job batching in Laravel?  

---

Here are detailed answers to your caching and queue-related questions in Laravel:

---

# **ðŸ“Œ Caching in Laravel**
## **1ï¸âƒ£ What are different cache drivers available in Laravel?**
Laravel supports multiple cache drivers, which can be configured in `.env` using `CACHE_DRIVER`. The available drivers are:
- **file** â€“ Stores cache in `storage/framework/cache` (default).
- **database** â€“ Stores cache in a database table.
- **array** â€“ Stores cache in an array (for testing, non-persistent).
- **redis** â€“ Uses Redis for caching.
- **memcached** â€“ Uses Memcached for caching.
- **dynamodb** â€“ Amazon DynamoDB.
- **apc** â€“ Uses APCu.
- **octane** â€“ Caching optimized for Laravel Octane.
  
The cache driver is configured in `config/cache.php`.

---

## **2ï¸âƒ£ How do you store and retrieve data from the cache?**
```php
use Illuminate\Support\Facades\Cache;

// Store data
Cache::put('key', 'value', now()->addMinutes(10));

// Retrieve data
$value = Cache::get('key');

// Retrieve with default value if key doesn't exist
$value = Cache::get('key', 'default_value');
```

---

## **3ï¸âƒ£ What is the difference between `Cache::remember()` and `Cache::rememberForever()`?**
| Method | Behavior |
|--------|----------|
| `Cache::remember()` | Caches data for a specific time and retrieves it if already cached. |
| `Cache::rememberForever()` | Caches data permanently until manually cleared. |

**Example:**
```php
// Cache for 10 minutes
$users = Cache::remember('users', now()->addMinutes(10), function () {
    return DB::table('users')->get();
});

// Cache forever
$users = Cache::rememberForever('users_forever', function () {
    return DB::table('users')->get();
});
```

---

## **4ï¸âƒ£ How do you configure Redis cache in Laravel?**
1. **Install Redis via Composer**
   ```sh
   composer require predis/predis
   ```
2. **Update `.env` file**
   ```ini
   CACHE_DRIVER=redis
   REDIS_CLIENT=predis
   REDIS_HOST=127.0.0.1
   REDIS_PASSWORD=null
   REDIS_PORT=6379
   ```
3. **Use Redis for caching**
   ```php
   Cache::put('key', 'value', 600); // Store in Redis
   $value = Cache::get('key'); // Retrieve from Redis
   ```

---

## **5ï¸âƒ£ How do you clear different types of caches in Laravel?**
| **Cache Type** | **Command** |
|--------------|----------------|
| **Application Cache** | `php artisan cache:clear` |
| **Config Cache** | `php artisan config:clear` |
| **View Cache** | `php artisan view:clear` |
| **Route Cache** | `php artisan route:clear` |
| **Clear Specific Cache Key** | `Cache::forget('key');` |
| **Clear Redis Cache** | `php artisan cache:clear && redis-cli FLUSHALL` |

---

## **6ï¸âƒ£ What are the benefits of caching?**
âœ… Improves performance by reducing database queries.  
âœ… Reduces server load by serving precomputed results.  
âœ… Enhances response time for frequently accessed data.  
âœ… Helps in scaling applications efficiently.  

---

## **7ï¸âƒ£ What is the difference between `CACHE_DRIVER=file` and `CACHE_DRIVER=database`?**
| **Driver** | **Storage Location** | **Best Used For** |
|------------|--------------------|----------------|
| `file` | Stores cache in files inside `storage/framework/cache` | Small applications with limited caching needs. |
| `database` | Stores cache in a dedicated database table | When multiple servers need shared cache. |

---

# **ðŸ“Œ Laravel Queues**
## **1ï¸âƒ£ What is a queue in Laravel, and why is it used?**
A **queue** in Laravel is a system for deferring time-consuming tasks (e.g., sending emails, processing images) to improve application responsiveness.

Example:
Instead of **sending an email synchronously**, we push it to a queue for background processing.

---

## **2ï¸âƒ£ How do you implement job queues in Laravel?**
1. **Set Queue Driver in `.env`**  
   ```ini
   QUEUE_CONNECTION=database
   ```
2. **Run Migration for Jobs Table**  
   ```sh
   php artisan queue:table
   php artisan migrate
   ```
3. **Create a Job**
   ```sh
   php artisan make:job SendEmailJob
   ```
4. **Inside Job (`app/Jobs/SendEmailJob.php`)**
   ```php
   use Mail;
   use App\Mail\WelcomeMail;

   public function handle() {
       Mail::to($this->user->email)->send(new WelcomeMail($this->user));
   }
   ```
5. **Dispatch Job**
   ```php
   dispatch(new SendEmailJob($user));
   ```

6. **Run Queue Worker**
   ```sh
   php artisan queue:work
   ```

---

## **3ï¸âƒ£ What is the difference between `dispatch()` and `dispatchNow()`?**
| **Method** | **Behavior** |
|------------|-------------|
| `dispatch()` | Pushes the job to the queue for background processing. |
| `dispatchNow()` | Executes the job immediately, without queueing. |

Example:
```php
dispatch(new SendEmailJob($user)); // Queued
dispatchNow(new SendEmailJob($user)); // Executes immediately
```

---

## **4ï¸âƒ£ How do you retry failed jobs in Laravel queues?**
- **Check failed jobs:**  
  ```sh
  php artisan queue:failed
  ```
- **Retry all failed jobs:**  
  ```sh
  php artisan queue:retry all
  ```
- **Retry a specific job:**  
  ```sh
  php artisan queue:retry {job_id}
  ```

---

## **5ï¸âƒ£ How do you prioritize jobs in Laravel queues?**
Define **multiple queues** and set priority:
```sh
php artisan queue:work --queue=high,default,low
```
ðŸ“Œ **Jobs in the `high` queue will run before `default` and `low` queues.**

---

## **6ï¸âƒ£ What is the difference between `queue:work` and `queue:listen`?**
| **Command** | **Behavior** |
|------------|-------------|
| `queue:work` | Processes jobs **continuously** (recommended for production). |
| `queue:listen` | Listens for new jobs and spawns a process **per job** (not efficient). |

ðŸš€ **For production, always use:**
```sh
php artisan queue:work --daemon
```

---

## **7ï¸âƒ£ How do you configure Supervisor for Laravel queues?**
Supervisor ensures that **queue workers run continuously**.

1. **Install Supervisor (Linux)**
   ```sh
   sudo apt-get install supervisor
   ```
2. **Create a Config File**
   ```ini
   [program:laravel-worker]
   process_name=%(program_name)s_%(process_num)02d
   command=php /path-to-project/artisan queue:work --tries=3
   autostart=true
   autorestart=true
   numprocs=3
   stdout_logfile=/var/log/worker.log
   stderr_logfile=/var/log/worker-error.log
   ```
3. **Restart Supervisor**
   ```sh
   sudo supervisorctl reread
   sudo supervisorctl update
   sudo supervisorctl start laravel-worker:*
   ```

---

## **8ï¸âƒ£ What is job batching in Laravel?**
Job batching allows executing **multiple jobs in parallel** and triggering events when all jobs are completed.

```php
use Illuminate\Bus\Batch;
use Illuminate\Support\Facades\Bus;

Bus::batch([
    new JobOne(),
    new JobTwo(),
    new JobThree(),
])->then(function (Batch $batch) {
    // When all jobs are completed
})->catch(function (Batch $batch, Throwable $e) {
    // Handle failed batch
})->dispatch();
```

---

## **ðŸš€ Summary**
âœ” Use caching for **faster performance and reduced database load**.  
âœ” Use queues for **background task processing**.  
âœ” **Prioritize jobs**, **handle failures**, and **optimize queue performance** with **Supervisor**.  

Let me know if you need further clarification! ðŸš€ðŸ”¥