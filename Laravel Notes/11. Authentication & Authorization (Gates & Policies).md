# **11. Authentication & Authorization (Gates & Policies) in Laravel**  

Authentication and authorization are crucial for securing Laravel applications. Authentication ensures users can log in, while authorization determines what actions they can perform.  

---

## **1. Laravel Authentication System**  

Laravel provides authentication out of the box using `laravel/ui` or `Laravel Breeze`/`Laravel Jetstream`.  

### **Installing Authentication Scaffolding**  
- **Laravel Breeze (For basic auth with Tailwind CSS)**  
```bash
composer require laravel/breeze --dev
php artisan breeze:install
php artisan migrate
npm install && npm run dev
```

- **Laravel UI (For Bootstrap-based authentication)**  
```bash
composer require laravel/ui
php artisan ui bootstrap --auth
npm install && npm run dev
```

- **Laravel Jetstream (For advanced auth with teams, API support, etc.)**  
```bash
composer require laravel/jetstream
php artisan jetstream:install livewire
php artisan migrate
npm install && npm run dev
```

---

## **2. Manual Authentication (Custom Login System)**  

If you don't want to use Laravel's built-in authentication, you can manually authenticate users.  

### **Login Controller (`AuthController.php`)**  
```php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class AuthController extends Controller
{
    public function login(Request $request)
    {
        $credentials = $request->validate([
            'email' => 'required|email',
            'password' => 'required',
        ]);

        if (Auth::attempt($credentials)) {
            return redirect()->intended('dashboard');
        }

        return back()->withErrors(['email' => 'Invalid credentials']);
    }

    public function logout(Request $request)
    {
        Auth::logout();
        return redirect('/');
    }
}
```

### **Routes (`web.php`)**
```php
Route::get('/login', [AuthController::class, 'showLoginForm'])->name('login');
Route::post('/login', [AuthController::class, 'login']);
Route::post('/logout', [AuthController::class, 'logout'])->name('logout');
```

---

## **3. Authorization in Laravel (Gates & Policies)**  

Laravel provides two ways to handle authorization:  
1. **Gates** – Used for simple, single-action checks.  
2. **Policies** – Used for resource-based permissions (e.g., managing users, posts, etc.).  

---

## **4. Gates (Single Action Authorization)**  

### **Defining a Gate in `AuthServiceProvider.php`**  
```php
use Illuminate\Support\Facades\Gate;
use App\Models\User;

public function boot()
{
    Gate::define('edit-posts', function (User $user) {
        return $user->role === 'admin';
    });
}
```

### **Using Gates in Controllers**  
```php
if (Gate::allows('edit-posts')) {
    // The user can edit posts
} else {
    abort(403);
}
```

OR  
```php
Gate::authorize('edit-posts');
```

### **Using Gates in Blade Views**  
```blade
@can('edit-posts')
    <a href="{{ route('posts.edit', $post) }}">Edit</a>
@endcan
```

---

## **5. Policies (Resource-based Authorization)**  

Policies are used when multiple actions need to be authorized for a model (e.g., creating, updating, deleting).  

### **Creating a Policy**  
```bash
php artisan make:policy PostPolicy --model=Post
```

### **Defining Rules in `PostPolicy.php`**  
```php
namespace App\Policies;

use App\Models\Post;
use App\Models\User;

class PostPolicy
{
    public function update(User $user, Post $post)
    {
        return $user->id === $post->user_id; // Allow only post owner to update
    }

    public function delete(User $user, Post $post)
    {
        return $user->role === 'admin';
    }
}
```

### **Registering the Policy in `AuthServiceProvider.php`**  
```php
use App\Models\Post;
use App\Policies\PostPolicy;

protected $policies = [
    Post::class => PostPolicy::class,
];
```

### **Using Policies in Controllers**  
```php
public function update(Request $request, Post $post)
{
    $this->authorize('update', $post);

    $post->update($request->all());

    return redirect()->route('posts.index');
}
```

### **Using Policies in Blade Views**  
```blade
@can('update', $post)
    <a href="{{ route('posts.edit', $post) }}">Edit</a>
@endcan
```

---

## **6. Role-Based Access Control (RBAC) with Gates & Policies**  

To simplify role-based access, define a **dynamic gate**:  
```php
Gate::define('role', function (User $user, $role) {
    return $user->role === $role;
});
```

Usage:  
```blade
@can('role', 'admin')
    <a href="/admin">Admin Dashboard</a>
@endcan
```

---

## **7. API Authentication (Sanctum & Passport)**  

Laravel provides two main ways to authenticate API users:  
1. **Laravel Sanctum** – Lightweight, token-based authentication.  
2. **Laravel Passport** – Full OAuth2 authentication with JWT support.  

### **Sanctum Installation & Setup**  
```bash
composer require laravel/sanctum
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
php artisan migrate
```

Add Sanctum middleware in `api.php`:  
```php
use Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful;

protected $middlewareGroups = [
    'api' => [
        EnsureFrontendRequestsAreStateful::class,
        'throttle:api',
    ],
];
```

### **Authenticating API Users with Sanctum**  
```php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use App\Models\User;

public function login(Request $request)
{
    $user = User::where('email', $request->email)->first();

    if (! $user || ! Hash::check($request->password, $user->password)) {
        return response()->json(['error' => 'Invalid credentials'], 401);
    }

    return response()->json(['token' => $user->createToken('API Token')->plainTextToken]);
}
```

Using API token for authentication in requests:  
```bash
curl -H "Authorization: Bearer {TOKEN}" http://your-api-url.com/api/user
```

---

## **8. Best Practices for Authentication & Authorization**  
✅ Use **middleware** for route protection.  
✅ Apply **Gates for single checks** and **Policies for resource permissions**.  
✅ Always **hash passwords** using `bcrypt()` or Laravel's `Hash` facade.  
✅ Implement **rate limiting** for login attempts using `throttle` middleware.  
✅ Use **API authentication** like Sanctum for mobile/web apps.  

---

## **9. Common Interview Questions on Authentication & Authorization**  

1. What is the difference between authentication and authorization?  
2. How do you manually authenticate users in Laravel?  
3. What is the difference between Gates and Policies in Laravel?  
4. How do you define and register a Policy?  
5. How do you implement role-based access control in Laravel?  
6. What is Laravel Sanctum, and how is it different from Passport?  
7. How do you protect API routes with Laravel Sanctum?  
8. What are some best practices for securing authentication in Laravel?  
9. How do you handle authorization inside Blade templates?  
10. How can you throttle login attempts in Laravel?  

---
