# **15. File Storage & Cloud Integration**  

Laravel provides a powerful filesystem abstraction using the **Flysystem** package, supporting local storage, Amazon S3, Google Cloud Storage, and other cloud providers.

---

## **1. Storage Configuration in Laravel**  

### **Default Filesystem Setup**  
Laravel's storage configuration is found in `config/filesystems.php`.  
```php
'default' => env('FILESYSTEM_DISK', 'local'),
```
You can set this in your `.env` file:  
```env
FILESYSTEM_DISK=local
```
Supported drivers:  
✅ `local` (stores files in `storage/app`)  
✅ `public` (stores files in `storage/app/public`)  
✅ `s3` (Amazon S3 or compatible cloud storage)  
✅ `ftp`, `sftp`, `rackspace` (third-party storage options)

---

## **2. Storing Files Locally**  

### **Saving Files to Storage**  
```php
use Illuminate\Support\Facades\Storage;

$file = $request->file('avatar');
$path = $file->store('avatars'); // Stores in storage/app/avatars
```

### **Customizing File Paths**  
```php
$path = $file->storeAs('avatars', 'user-profile.jpg');
```

### **Retrieving Files**  
```php
$url = Storage::url('avatars/user-profile.jpg');
```

### **Checking File Existence**  
```php
if (Storage::exists('avatars/user-profile.jpg')) {
    // File exists
}
```

---

## **3. File Uploads with Validation**  

### **Controller Example**
```php
public function upload(Request $request)
{
    $request->validate([
        'file' => 'required|mimes:jpg,png|max:2048',
    ]);

    $path = $request->file('file')->store('uploads');

    return response()->json(['path' => $path]);
}
```

---

## **4. Storing Files in Public Storage**  

### **Public Disk (Accessible via URL)**  
```php
$path = $file->store('images', 'public');
$url = Storage::url($path);
```
Laravel stores public files in `storage/app/public`, which must be linked to `public/storage`:  
```bash
php artisan storage:link
```
This allows public access via:  
```
https://yourdomain.com/storage/images/filename.jpg
```

---

## **5. File Deletion & Management**  

### **Deleting Files**
```php
Storage::delete('avatars/user-profile.jpg');
```

### **Getting All Files in a Directory**  
```php
$files = Storage::files('avatars');
```

### **Getting All Files Recursively**  
```php
$allFiles = Storage::allFiles('avatars');
```

---

## **6. Cloud Storage Integration (Amazon S3 Example)**  

### **Step 1: Install AWS SDK**  
```bash
composer require league/flysystem-aws-s3-v3
```

### **Step 2: Configure S3 in `.env`**
```env
FILESYSTEM_DISK=s3
AWS_ACCESS_KEY_ID=your-key
AWS_SECRET_ACCESS_KEY=your-secret
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=your-bucket-name
AWS_URL=https://your-bucket.s3.amazonaws.com
```

### **Step 3: Use S3 for File Uploads**  
```php
$filePath = $request->file('image')->store('uploads', 's3');
$url = Storage::disk('s3')->url($filePath);
```

### **Step 4: Deleting Files from S3**  
```php
Storage::disk('s3')->delete('uploads/image.jpg');
```

---

## **7. Google Cloud Storage Integration**  

### **Step 1: Install Google Cloud Storage Driver**  
```bash
composer require superbalist/laravel-google-cloud-storage
```

### **Step 2: Configure Google Cloud Storage in `.env`**  
```env
FILESYSTEM_DISK=gcs
GOOGLE_CLOUD_PROJECT_ID=your-project-id
GOOGLE_CLOUD_STORAGE_BUCKET=your-bucket-name
GOOGLE_CLOUD_KEY_FILE_PATH=/path-to-your-key.json
```

### **Step 3: Uploading Files to Google Cloud Storage**  
```php
Storage::disk('gcs')->put('uploads/test.jpg', file_get_contents($file));
```

---

## **8. File Downloading**  

### **Download File from Storage**  
```php
return Storage::download('avatars/user-profile.jpg');
```

### **Download with Custom Name**  
```php
return Storage::download('avatars/user-profile.jpg', 'custom-name.jpg');
```

---

## **9. Secure File Access with Signed URLs**  
```php
use Illuminate\Support\Facades\Storage;

$url = Storage::temporaryUrl(
    'uploads/private-file.pdf',
    now()->addMinutes(5)
);
```
The file is accessible only for a limited time.

---

## **10. Best Practices for File Storage**  

✅ Use **cloud storage (S3, GCS)** for scalability.  
✅ Always validate **file types and sizes** before uploading.  
✅ Use **signed URLs** for secure downloads.  
✅ Leverage **Laravel Queues** for processing large file uploads.  
✅ Store **metadata in the database** (e.g., filenames, URLs).  

---

## **11. Common Interview Questions on File Storage**  

1. How does Laravel handle **file storage**?  
2. What is the difference between `local`, `public`, and `cloud` disks?  
3. How do you configure **Amazon S3** in Laravel?  
4. What is the purpose of the `storage:link` command?  
5. How do you create **temporary URLs** for secure file access?  
6. How do you **delete files** from the storage disk?  
7. How do you store **files with a custom filename**?  
8. What are the benefits of using **cloud storage over local storage**?  
9. How do you list **all files in a directory** using Laravel's storage system?  
10. How do you handle **large file uploads** efficiently?  

---
