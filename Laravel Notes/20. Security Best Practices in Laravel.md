# **20. Security Best Practices in Laravel**  

Laravel provides built-in security features to protect applications from common vulnerabilities such as **SQL injection, XSS, CSRF, authentication bypass, and data leaks**. Below are the **best security practices** every Laravel developer should follow.  

---

## **1. SQL Injection Protection**  
Laravel’s **Eloquent ORM** and **Query Builder** automatically protect against SQL injection.  

### ✅ **Use Eloquent ORM or Query Builder (Avoid Raw Queries)**  
❌ **Bad Example (Vulnerable to SQL Injection)**  
```php
$users = DB::select("SELECT * FROM users WHERE email = '$email'");
```
✅ **Good Example (Safe)**  
```php
$users = DB::table('users')->where('email', $email)->get();
```
✅ **Using Eloquent ORM**  
```php
$users = User::where('email', $email)->get();
```
✅ **Using Parameter Binding in Raw Queries**  
```php
$users = DB::select("SELECT * FROM users WHERE email = ?", [$email]);
```

---

## **2. Cross-Site Scripting (XSS) Protection**  
XSS allows attackers to inject malicious scripts into web pages viewed by other users.  

### ✅ **Use Blade Escaping (`{{ }}` instead of `{!! !!}`)**  
❌ **Bad Example (Vulnerable to XSS)**  
```php
{!! $user->name !!}
```
✅ **Good Example (Escapes HTML characters)**  
```php
{{ $user->name }}
```

### ✅ **Sanitize User Input**  
Use Laravel’s built-in **Str::sanitize()** or `strip_tags()` to clean input:  
```php
use Illuminate\Support\Str;

$cleaned_input = Str::of($input)->stripTags();
```

---

## **3. Cross-Site Request Forgery (CSRF) Protection**  
CSRF attacks trick users into performing unwanted actions on a different website.  

### ✅ **Enable CSRF Protection in Forms**  
Laravel automatically includes a CSRF token in forms.  
```html
<form method="POST" action="/submit">
    @csrf
    <button type="submit">Submit</button>
</form>
```
✅ **For AJAX Requests, Include CSRF Token**  
```js
$.ajaxSetup({
    headers: {
        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
    }
});
```

---

## **4. Authentication & Authorization**  
Laravel uses **bcrypt for password hashing** and provides a robust **Gates & Policies** system for authorization.  

### ✅ **Use Laravel's `Hash::make()` for Password Hashing**  
❌ **Bad Example (DO NOT store plain passwords)**  
```php
$user->password = $request->password; // ❌ Never store raw passwords
```
✅ **Good Example (Use Hashing)**  
```php
use Illuminate\Support\Facades\Hash;

$user->password = Hash::make($request->password);
```

### ✅ **Use Laravel Gates & Policies for Authorization**  
#### **Example: Using Gates**
```php
use Illuminate\Support\Facades\Gate;

Gate::define('edit-post', function ($user, $post) {
    return $user->id === $post->user_id;
});

if (Gate::allows('edit-post', $post)) {
    // User can edit post
}
```
#### **Example: Using Policies**
Generate a policy:  
```bash
php artisan make:policy PostPolicy --model=Post
```
Define authorization in `PostPolicy.php`:  
```php
public function update(User $user, Post $post)
{
    return $user->id === $post->user_id;
}
```

---

## **5. Secure API Development**  
### ✅ **Use API Authentication (Sanctum or Passport)**  
#### **Sanctum (Lightweight Token Authentication)**
```bash
composer require laravel/sanctum
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
php artisan migrate
```
Add middleware in `app/Http/Kernel.php`:  
```php
'api' => [
    \Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful::class,
    'throttle:api',
    \Illuminate\Routing\Middleware\SubstituteBindings::class,
],
```
Protect routes with authentication:  
```php
Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});
```

---

## **6. Secure File Uploads**  
### ✅ **Validate File Uploads**  
```php
$request->validate([
    'avatar' => 'required|file|mimes:jpeg,png,jpg|max:2048'
]);
```

### ✅ **Store Files Outside the Public Folder**  
Use Laravel’s `storage/app` directory instead of `public/` to prevent direct access.  
```php
$path = $request->file('avatar')->store('avatars');
```

---

## **7. Secure Cookies & Sessions**  
### ✅ **Set Secure Cookies**  
In `config/session.php`:  
```php
'same_site' => 'strict',
'secure' => env('APP_ENV') !== 'local',
```

### ✅ **Regenerate Session on Login**  
```php
Auth::login($user);
$request->session()->regenerate();
```

---

## **8. Prevent Mass Assignment**  
Laravel prevents mass assignment attacks using **fillable** or **guarded** properties in models.  

### ✅ **Use `$fillable` to Define Allowed Fields**  
```php
class User extends Model
{
    protected $fillable = ['name', 'email', 'password'];
}
```
### ❌ **Avoid Using `$guarded = [];`**  
This allows any field to be updated, creating security risks.

---

## **9. Rate Limiting & Throttling**  
Prevent brute-force attacks on login forms & APIs.  

### ✅ **Use Laravel’s Rate Limiting Middleware**  
```php
Route::middleware(['throttle:10,1'])->group(function () {
    Route::post('/login', 'AuthController@login');
});
```
This limits users to **10 requests per minute**.

---

## **10. Secure Deployment Practices**  
### ✅ **Disable Debug Mode in Production**  
Never expose environment variables to attackers.  
Set in `.env` file:  
```ini
APP_DEBUG=false
```

### ✅ **Use Environment Variables for Sensitive Data**  
❌ **Bad Example (Hardcoded Credentials)**  
```php
DB_USERNAME = 'root';
DB_PASSWORD = 'secret';
```
✅ **Good Example (Use `.env` file)**  
```ini
DB_USERNAME=root
DB_PASSWORD=secret
```
Access in Laravel:  
```php
DB::connection()->getConfig('username');
```

---

## **11. Security Headers in Laravel**  
### ✅ **Use `helmet`-like Middleware for Secure Headers**  
Install Laravel Security Headers Middleware:  
```bash
composer require bepsvpt/secure-headers
```
Add it to `Kernel.php`:  
```php
\Bepsvpt\SecureHeaders\SecureHeadersMiddleware::class
```

---

## **12. Security Best Practices Recap**  
✅ **Use Query Builder & Eloquent to prevent SQL Injection**  
✅ **Escape output using `{{ }}` to prevent XSS**  
✅ **Use CSRF tokens in forms and AJAX requests**  
✅ **Hash passwords using `Hash::make()`**  
✅ **Use API authentication (Sanctum/Passport)**  
✅ **Validate file uploads and store them securely**  
✅ **Enable rate limiting to prevent brute-force attacks**  
✅ **Set security headers & disable debug mode in production**  

---

## **13. Common Interview Questions on Laravel Security**  
1. What are SQL injection attacks, and how does Laravel prevent them?  
2. How does Laravel handle XSS prevention?  
3. What is CSRF protection, and how does Laravel implement it?  
4. How do you secure Laravel APIs using authentication?  
5. What are Laravel Policies and Gates, and how do they enhance security?  
6. How do you prevent mass assignment vulnerabilities in Laravel?  
7. How do you set up rate limiting in Laravel?  
8. What is session hijacking, and how does Laravel protect against it?  

---
