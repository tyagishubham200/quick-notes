# **4. Routing and Middleware**  

## **Routing in Laravel**  
Routing in Laravel is responsible for mapping **URLs to controllers or closures**. It is defined inside the `routes/` directory.

### **Types of Routes in Laravel**  
1. **Basic Route (Closure-based)**
   ```php
   Route::get('/welcome', function () {
       return 'Welcome to Laravel!';
   });
   ```
2. **Route with Controller**
   ```php
   Route::get('/users', [UserController::class, 'index']);
   ```
3. **Route Parameters**
   - **Required Parameter**
     ```php
     Route::get('/user/{id}', function ($id) {
         return "User ID: $id";
     });
     ```
   - **Optional Parameter**
     ```php
     Route::get('/user/{name?}', function ($name = 'Guest') {
         return "Hello, $name";
     });
     ```
4. **Named Routes** (Useful for generating URLs)
   ```php
   Route::get('/profile', [ProfileController::class, 'show'])->name('profile');
   ```
   - Usage:
     ```php
     return redirect()->route('profile');
     ```
5. **Route Groups**
   - **Middleware Grouping**
     ```php
     Route::middleware(['auth'])->group(function () {
         Route::get('/dashboard', [DashboardController::class, 'index']);
     });
     ```
   - **Prefixing Routes**
     ```php
     Route::prefix('admin')->group(function () {
         Route::get('/users', [AdminController::class, 'users']);
     });
     ```
   - **Namespace Grouping**
     ```php
     Route::namespace('Admin')->group(function () {
         Route::get('/settings', [SettingsController::class, 'index']);
     });
     ```
6. **API Routes (Defined in `routes/api.php`)**
   ```php
   Route::apiResource('posts', PostController::class);
   ```
7. **Falling Back Route (404 Handling)**
   ```php
   Route::fallback(function () {
       return response()->json(['message' => 'Not Found'], 404);
   });
   ```

---

## **Middleware in Laravel**  
Middleware filters HTTP requests before they reach the controller.

### **Common Middleware Types**
| Middleware | Purpose |
|------------|---------|
| `auth` | Ensures user is authenticated |
| `guest` | Restricts access to guests only |
| `throttle` | Limits API request rates |
| `cors` | Handles CORS (Cross-Origin Resource Sharing) |
| `encryptCookies` | Encrypts cookies for security |
| `trimStrings` | Removes extra spaces from input |

### **Using Middleware in Routes**
```php
Route::get('/dashboard', [DashboardController::class, 'index'])->middleware('auth');
```

### **Creating Custom Middleware**
```sh
php artisan make:middleware CheckUserStatus
```
- Modify `app/Http/Middleware/CheckUserStatus.php`
  ```php
  namespace App\Http\Middleware;

  use Closure;
  use Illuminate\Http\Request;

  class CheckUserStatus
  {
      public function handle(Request $request, Closure $next)
      {
          if (auth()->user() && auth()->user()->status !== 'active') {
              return response('Access Denied', 403);
          }
          return $next($request);
      }
  }
  ```
- Register middleware in `app/Http/Kernel.php`
  ```php
  protected $routeMiddleware = [
      'checkstatus' => \App\Http\Middleware\CheckUserStatus::class,
  ];
  ```
- Use in routes:
  ```php
  Route::get('/dashboard', [DashboardController::class, 'index'])->middleware('checkstatus');
  ```

---

## **Key Interview Questions on Routing & Middleware**
1. How does **Laravel routing** work?  
2. What are **route parameters**, and how do you define them?  
3. What is the difference between **web.php and api.php** routes?  
4. How do you use **named routes** in Laravel?  
5. Explain **route grouping** with prefixes and middleware.  
6. What is middleware in Laravel? Give an example of custom middleware.  
7. How does **rate limiting** work in Laravel routes?  
8. How can you handle **404 errors** using routes?  

---

### **1️⃣ How does Laravel routing work?**  
#### ✅ **Answer:**  
Laravel routing is how the application maps incoming HTTP requests to specific controllers, closures, or views. It is defined in `routes/web.php` and `routes/api.php`.  

#### 🔹 **Basic Route Example:**  
```php
Route::get('/welcome', function () {
    return 'Hello, Laravel!';
});
```
Here, when a user visits `/welcome`, Laravel will return `"Hello, Laravel!"`.

#### 🔹 **Controller-based Route:**  
```php
Route::get('/user/{id}', [UserController::class, 'show']);
```
This maps `/user/{id}` to the `show()` method in `UserController`.

---

### **2️⃣ What are route parameters, and how do you define them?**  
#### ✅ **Answer:**  
Route parameters allow passing dynamic values in URLs. There are two types: **required** and **optional** parameters.

#### 🔹 **Required Parameters:**  
```php
Route::get('/user/{id}', function ($id) {
    return "User ID: " . $id;
});
```
- `/user/10` → Output: **User ID: 10**
- `/user/abc` → Output: **User ID: abc**

#### 🔹 **Optional Parameters:**  
Use `?` to make a parameter optional and provide a default value:  
```php
Route::get('/profile/{name?}', function ($name = 'Guest') {
    return "Hello, " . $name;
});
```
- `/profile/Alice` → Output: **Hello, Alice**
- `/profile/` → Output: **Hello, Guest**

#### 🔹 **Regular Expressions for Validation:**  
```php
Route::get('/user/{id}', function ($id) {
    return "User ID: " . $id;
})->where('id', '[0-9]+');
```
- `/user/10` → ✅ Allowed  
- `/user/abc` → ❌ Not allowed  

---

### **3️⃣ What is the difference between `web.php` and `api.php` routes?**  
#### ✅ **Answer:**  
| File | Purpose | Middleware | Example Usage |
|------|---------|------------|---------------|
| `web.php` | Handles **browser-based** routes | Uses `web` middleware (sessions, CSRF) | Views, forms, authentication |
| `api.php` | Handles **API requests** | Uses `api` middleware (no sessions) | RESTful APIs, JSON responses |

#### 🔹 **Example: `web.php` (With Views & Sessions)**  
```php
Route::get('/dashboard', function () {
    return view('dashboard');
});
```
#### 🔹 **Example: `api.php` (Returns JSON Response)**  
```php
Route::get('/users', function () {
    return response()->json(['name' => 'John Doe']);
});
```

---

### **4️⃣ How do you use named routes in Laravel?**  
#### ✅ **Answer:**  
Named routes allow referring to routes by a name instead of their URL.  

#### 🔹 **Defining Named Routes:**  
```php
Route::get('/user/profile', [UserController::class, 'profile'])->name('profile');
```
#### 🔹 **Generating URLs using Named Routes:**  
```php
$url = route('profile'); // Generates '/user/profile'
```
#### 🔹 **Redirecting Using Named Routes:**  
```php
return redirect()->route('profile');
```
✔ Named routes make URL changes easier because you don’t need to update every reference.

---

### **5️⃣ Explain route grouping with prefixes and middleware.**  
#### ✅ **Answer:**  
Route groups allow applying **prefixes**, **middleware**, and **namespace** to multiple routes.  

#### 🔹 **Example: Prefixing Routes**  
```php
Route::prefix('admin')->group(function () {
    Route::get('/dashboard', [AdminController::class, 'dashboard']);
    Route::get('/users', [AdminController::class, 'users']);
});
```
Now the URLs are:
- `/admin/dashboard`
- `/admin/users`

#### 🔹 **Example: Applying Middleware to a Group**  
```php
Route::middleware(['auth'])->group(function () {
    Route::get('/dashboard', function () {
        return view('dashboard');
    });
});
```
All routes inside this group require authentication (`auth` middleware).

---

### **6️⃣ What is middleware in Laravel? Give an example of custom middleware.**  
#### ✅ **Answer:**  
Middleware filters HTTP requests before they reach controllers.  

#### 🔹 **Built-in Middleware Example (`auth` Middleware)**  
```php
Route::get('/dashboard', function () {
    return view('dashboard');
})->middleware('auth');
```
✔ Only **authenticated users** can access `/dashboard`.

#### 🔹 **Creating Custom Middleware:**  
1️⃣ **Generate Middleware using Artisan:**  
```sh
php artisan make:middleware CheckAge
```
2️⃣ **Modify Middleware (`app/Http/Middleware/CheckAge.php`)**  
```php
public function handle($request, Closure $next)
{
    if ($request->age < 18) {
        return redirect('home');
    }
    return $next($request);
}
```
3️⃣ **Apply Middleware to Routes (`web.php`)**  
```php
Route::get('/restricted', function () {
    return "Welcome to the restricted page!";
})->middleware('checkAge');
```
✔ Users under 18 are redirected.

---

### **7️⃣ How does rate limiting work in Laravel routes?**  
#### ✅ **Answer:**  
Rate limiting protects against abuse by restricting the number of requests per user/IP.

#### 🔹 **Basic Rate Limiting Example:**  
```php
Route::middleware('throttle:60,1')->group(function () {
    Route::get('/api/data', function () {
        return response()->json(['message' => 'Success']);
    });
});
```
✔ Allows **60 requests per minute** for each user.

#### 🔹 **Customizing Rate Limiting in `app/Providers/RouteServiceProvider.php`:**  
```php
use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Support\Facades\RateLimiter;

RateLimiter::for('api', function () {
    return Limit::perMinute(100)->by(request()->ip());
});
```
✔ Now, API routes allow **100 requests per minute per IP**.

---

### **8️⃣ How can you handle 404 errors using routes?**  
#### ✅ **Answer:**  
Laravel automatically returns a **404 response** if a route does not exist, but you can customize it.

#### 🔹 **Handling 404 Errors Using a Fallback Route:**  
```php
Route::fallback(function () {
    return response()->view('errors.404', [], 404);
});
```
✔ If no route matches, Laravel shows a custom **404 page**.

#### 🔹 **Handling 404 Errors in `App\Exceptions\Handler.php`:**  
Modify `render()` method:
```php
public function render($request, Throwable $exception)
{
    if ($exception instanceof NotFoundHttpException) {
        return response()->view('errors.404', [], 404);
    }
    return parent::render($request, $exception);
}
```
✔ Now, missing routes show a custom **errors.404** page.

---

### **Final Summary**
| Question | Key Takeaway |
|----------|-------------|
| **How does routing work?** | Laravel maps URLs to controllers, views, or closures. |
| **Route Parameters?** | Use `{param}` for required and `{param?}` for optional parameters. |
| **Difference between `web.php` & `api.php`?** | `web.php` for browser routes (sessions, views), `api.php` for API routes (JSON). |
| **Named Routes?** | Use `name()` to define, `route('name')` to generate URLs. |
| **Route Groups?** | Use `prefix()`, `middleware()`, and `namespace()` for grouping. |
| **Middleware?** | Middleware filters requests (e.g., `auth`, `throttle`). |
| **Rate Limiting?** | Protects against excessive requests (`throttle:60,1`). |
| **Handling 404 Errors?** | Use `Route::fallback()` or modify `Handler.php`. |

✔ Let me know if you need more examples! 🚀