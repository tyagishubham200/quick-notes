# **12. API Development in Laravel (Sanctum & Passport)**  

API development in Laravel is streamlined with built-in tools for authentication, request handling, and response formatting. Laravel provides two primary authentication methods for APIs:  
- **Sanctum** – Lightweight API token authentication for SPAs and mobile apps.  
- **Passport** – Full OAuth2 authentication for complex applications.  

---

## **1. Creating a Laravel API**  

### **Generating an API Controller**
```bash
php artisan make:controller Api\UserController --api
```
This command creates a controller without `create` and `edit` methods, as APIs do not use views.

### **Defining API Routes (`routes/api.php`)**  
```php
use App\Http\Controllers\Api\UserController;

Route::get('/users', [UserController::class, 'index']);
Route::post('/users', [UserController::class, 'store']);
Route::get('/users/{id}', [UserController::class, 'show']);
Route::put('/users/{id}', [UserController::class, 'update']);
Route::delete('/users/{id}', [UserController::class, 'destroy']);
```

---

## **2. API Authentication with Laravel Sanctum**  

### **Installing Sanctum**  
```bash
composer require laravel/sanctum
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"
php artisan migrate
```

### **Adding Sanctum Middleware in `api.php`**  
Modify `app/Http/Kernel.php`:  
```php
use Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful;

protected $middlewareGroups = [
    'api' => [
        EnsureFrontendRequestsAreStateful::class,
        'throttle:api',
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
    ],
];
```

### **Configuring Sanctum in `config/sanctum.php`**  
```php
'stateful' => explode(',', env('SANCTUM_STATEFUL_DOMAINS', 'localhost,127.0.0.1')),
```

### **Generating API Tokens in `AuthController.php`**
```php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use App\Models\User;

public function login(Request $request)
{
    $request->validate([
        'email' => 'required|email',
        'password' => 'required',
    ]);

    $user = User::where('email', $request->email)->first();

    if (! $user || ! Hash::check($request->password, $user->password)) {
        return response()->json(['message' => 'Invalid credentials'], 401);
    }

    return response()->json(['token' => $user->createToken('API Token')->plainTextToken]);
}
```

### **Using API Tokens in Requests**  
```bash
curl -H "Authorization: Bearer {TOKEN}" http://your-api-url.com/api/user
```

### **Protecting API Routes with Sanctum Middleware**
```php
Route::middleware('auth:sanctum')->get('/user', function (Request $request) {
    return $request->user();
});
```

---

## **3. API Authentication with Laravel Passport**  

### **Installing Passport**
```bash
composer require laravel/passport
php artisan passport:install
php artisan migrate
```

### **Registering Passport in `AuthServiceProvider.php`**  
```php
use Laravel\Passport\Passport;

public function boot()
{
    Passport::routes();
}
```

### **Configuring Passport in `config/auth.php`**
```php
'guards' => [
    'api' => [
        'driver' => 'passport',
        'provider' => 'users',
    ],
],
```

### **Generating API Tokens in `AuthController.php`**
```php
public function login(Request $request)
{
    $credentials = $request->validate([
        'email' => 'required|email',
        'password' => 'required',
    ]);

    if (!Auth::attempt($credentials)) {
        return response()->json(['message' => 'Unauthorized'], 401);
    }

    $user = Auth::user();
    $token = $user->createToken('API Token')->accessToken;

    return response()->json(['token' => $token]);
}
```

### **Protecting API Routes with Passport Middleware**
```php
Route::middleware('auth:api')->get('/user', function (Request $request) {
    return $request->user();
});
```

### **Using Passport API Token in Requests**
```bash
curl -H "Authorization: Bearer {TOKEN}" http://your-api-url.com/api/user
```

---

## **4. API Resource Responses**  

### **Using API Resources (`php artisan make:resource UserResource`)**  
```php
use Illuminate\Http\Resources\Json\JsonResource;

class UserResource extends JsonResource
{
    public function toArray($request)
    {
        return [
            'id' => $this->id,
            'name' => $this->name,
            'email' => $this->email,
        ];
    }
}
```

### **Using API Resource in Controller**
```php
use App\Http\Resources\UserResource;

return new UserResource(User::findOrFail($id));
```

### **Returning a Collection**
```php
return UserResource::collection(User::all());
```

---

## **5. API Pagination & Filtering**  

### **Paginating API Results**
```php
return User::paginate(10);
```

### **Filtering API Data**
```php
public function index(Request $request)
{
    return User::where('role', $request->role)->paginate(10);
}
```

---

## **6. Handling API Errors & Validation**  

### **API Validation in Controller**
```php
use Illuminate\Http\Exceptions\HttpResponseException;

public function store(Request $request)
{
    $validator = Validator::make($request->all(), [
        'name' => 'required',
        'email' => 'required|email|unique:users',
        'password' => 'required|min:6',
    ]);

    if ($validator->fails()) {
        throw new HttpResponseException(response()->json($validator->errors(), 422));
    }

    return User::create($request->all());
}
```

### **Global Exception Handling (`app/Exceptions/Handler.php`)**  
```php
public function render($request, Throwable $exception)
{
    if ($request->is('api/*')) {
        return response()->json(['error' => $exception->getMessage()], 400);
    }

    return parent::render($request, $exception);
}
```

---

## **7. API Throttling & Rate Limiting**  

### **Applying Rate Limits to Routes**
```php
Route::middleware('throttle:60,1')->group(function () {
    Route::get('/users', [UserController::class, 'index']);
});
```
This allows **60 requests per minute per user**.

### **Customizing Rate Limits (`app/Providers/RouteServiceProvider.php`)**
```php
use Illuminate\Cache\RateLimiting\Limit;
use Illuminate\Support\Facades\RateLimiter;

public function boot()
{
    RateLimiter::for('api', function (Request $request) {
        return Limit::perMinute(100)->by($request->user()?->id ?: $request->ip());
    });
}
```

---

## **8. Best Practices for API Development in Laravel**  
✅ Use **API Resources** for structured responses.  
✅ Implement **authentication with Sanctum or Passport**.  
✅ Use **rate limiting to prevent abuse**.  
✅ Return **consistent JSON responses**.  
✅ Validate all inputs and return **error messages properly**.  
✅ Paginate large datasets to **improve performance**.  
✅ Handle errors globally using Laravel's **exception handling**.  

---

## **9. Common Interview Questions on API Development**  

1. What is the difference between Laravel Sanctum and Passport?  
2. How do you protect API routes using middleware?  
3. How do you implement token-based authentication in Laravel?  
4. What are Laravel API resources, and how do you use them?  
5. How do you handle API validation in Laravel?  
6. How can you implement API rate limiting?  
7. What are some best practices for API security in Laravel?  
8. How do you use Laravel’s exception handling for API responses?  
9. How do you structure API responses in Laravel?  
10. How do you implement pagination in API responses?  

---
