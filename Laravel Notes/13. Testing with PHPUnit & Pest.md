# **13. Testing with PHPUnit & Pest in Laravel**  

Testing in Laravel ensures that applications work as expected and prevents regressions. Laravel supports two primary testing frameworks:  

- **PHPUnit** – A widely used PHP testing framework.  
- **Pest** – A modern, concise, and expressive alternative to PHPUnit.  

---

## **1. Setting Up Testing in Laravel**  

Laravel comes with PHPUnit preconfigured. To ensure it’s installed, check `phpunit.xml`:  

```xml
<phpunit bootstrap="vendor/autoload.php" ...>
    <testsuites>
        <testsuite name="Application Test Suite">
            <directory suffix="Test.php">./tests</directory>
        </testsuite>
    </testsuites>
</phpunit>
```

Run tests using:  
```bash
php artisan test  # Uses Pest or PHPUnit
php vendor/bin/phpunit  # Runs PHPUnit directly
```

### **Creating a New Test**
```bash
php artisan make:test UserTest
```
For feature tests:  
```bash
php artisan make:test UserTest --unit
```

---

## **2. Types of Tests in Laravel**  

1. **Unit Tests** – Tests individual components (models, services).  
2. **Feature Tests** – Tests entire HTTP requests and responses.  
3. **Integration Tests** – Ensures multiple components work together.  
4. **Browser Tests (Dusk)** – Automates browser interactions (not covered here).  

---

## **3. Writing Unit Tests (PHPUnit)**  

### **Example: Testing a Model Method (`UserTest.php`)**
```php
use Tests\TestCase;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;

class UserTest extends TestCase
{
    use RefreshDatabase;  // Resets DB after each test

    public function test_user_can_be_created()
    {
        $user = User::factory()->create(['name' => 'John Doe']);

        $this->assertDatabaseHas('users', ['name' => 'John Doe']);
    }
}
```

---

## **4. Writing Feature Tests (PHPUnit)**  

### **Example: Testing a Route (`UserTest.php`)**
```php
public function test_user_can_login()
{
    $user = User::factory()->create([
        'email' => 'test@example.com',
        'password' => bcrypt('password123'),
    ]);

    $response = $this->post('/login', [
        'email' => 'test@example.com',
        'password' => 'password123',
    ]);

    $response->assertStatus(302);
    $this->assertAuthenticatedAs($user);
}
```

---

## **5. Testing API Endpoints (PHPUnit)**  

### **Example: Testing JSON Response (`UserApiTest.php`)**
```php
public function test_users_api_returns_data()
{
    User::factory(3)->create();

    $response = $this->getJson('/api/users');

    $response->assertStatus(200)
             ->assertJsonCount(3);
}
```

---

## **6. Writing Tests with Pest (Modern Alternative to PHPUnit)**  

### **Installing Pest in Laravel**
```bash
composer require pestphp/pest --dev
php artisan pest:install
```

### **Example: Writing a Pest Test**
```php
it('checks if the user table has data', function () {
    User::factory()->create();
    expect(User::count())->toBeGreaterThan(0);
});
```

### **Example: Testing a JSON Response with Pest**
```php
it('fetches all users', function () {
    User::factory(5)->create();
    
    $this->getJson('/api/users')
        ->assertStatus(200)
        ->assertJsonCount(5);
});
```

---

## **7. Mocking & Dependency Injection in Tests**  

### **Mocking External Services**
```php
use Illuminate\Support\Facades\Http;

public function test_fetching_external_api()
{
    Http::fake([
        'api.example.com/*' => Http::response(['message' => 'Success'], 200),
    ]);

    $response = Http::get('api.example.com/data');

    $this->assertEquals('Success', $response->json('message'));
}
```

### **Mocking Events & Listeners**
```php
use Illuminate\Support\Facades\Event;
use App\Events\UserRegistered;

public function test_event_is_dispatched()
{
    Event::fake();

    event(new UserRegistered());

    Event::assertDispatched(UserRegistered::class);
}
```

---

## **8. Testing Database Interactions**  

### **Using `RefreshDatabase` Trait (Recommended)**
```php
use Illuminate\Foundation\Testing\RefreshDatabase;

class ExampleTest extends TestCase
{
    use RefreshDatabase;
}
```
This will **reset the database** after every test.

### **Checking Database Data**
```php
public function test_database_has_record()
{
    User::factory()->create(['email' => 'test@example.com']);

    $this->assertDatabaseHas('users', ['email' => 'test@example.com']);
}
```

---

## **9. Best Practices for Laravel Testing**  

✅ Write tests for critical functionalities **before deployment**.  
✅ Use **factories** and **seeders** to generate test data.  
✅ Mock **external services** and **API calls**.  
✅ Use **Pest** for expressive and modern tests.  
✅ Leverage **RefreshDatabase** to reset state in tests.  
✅ Automate tests using **CI/CD pipelines**.  

---

## **10. Common Interview Questions on Laravel Testing**  

1. What is the difference between **unit testing** and **feature testing**?  
2. How do you **mock a service** in Laravel tests?  
3. What is the purpose of the **RefreshDatabase** trait?  
4. How do you test an **API response** in Laravel?  
5. What is Pest, and how is it different from PHPUnit?  
6. How do you ensure that an **event is dispatched** in a Laravel test?  
7. How do you test **authenticated routes**?  
8. How do you handle **database transactions in tests**?  
9. What is the benefit of **mocking dependencies** in testing?  
10. How can you integrate Laravel tests with a **CI/CD pipeline**?  

---
