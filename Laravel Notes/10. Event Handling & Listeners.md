# **10. Event Handling & Listeners in Laravel**  

Laravelâ€™s event system allows applications to listen for and respond to various actions, making it useful for **decoupling logic**, **logging actions**, and **triggering background jobs**.  

---

## **1. Understanding Events & Listeners**  
- **Events**: Represent actions happening in the application (e.g., UserRegistered, OrderPlaced).  
- **Listeners**: React to events and handle business logic (e.g., sending emails, logging activities).  

---

## **2. Creating Events & Listeners**  

Laravel provides an artisan command to generate events and listeners:  

```bash
php artisan make:event OrderShipped
php artisan make:listener SendShipmentNotification --event=OrderShipped
```

---

## **3. Defining an Event**  

`app/Events/OrderShipped.php`  
```php
namespace App\Events;

use App\Models\Order;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class OrderShipped
{
    use Dispatchable, SerializesModels;

    public $order;

    public function __construct(Order $order)
    {
        $this->order = $order;
    }
}
```
- `Dispatchable`: Allows the event to be dispatched.  
- `SerializesModels`: Automatically serializes the model when queued.  

---

## **4. Defining a Listener**  

`app/Listeners/SendShipmentNotification.php`  
```php
namespace App\Listeners;

use App\Events\OrderShipped;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Support\Facades\Mail;
use App\Mail\ShipmentMail;

class SendShipmentNotification implements ShouldQueue
{
    use InteractsWithQueue;

    public function handle(OrderShipped $event)
    {
        Mail::to($event->order->customer_email)->send(new ShipmentMail($event->order));
    }
}
```
- **`ShouldQueue`**: Indicates that the listener should be processed as a queued job.  
- **`InteractsWithQueue`**: Allows queue interactions like retrying or deleting jobs.  

---

## **5. Registering Events & Listeners**  

Laravel automatically registers events, but you can manually define them in `app/Providers/EventServiceProvider.php`:  

```php
use App\Events\OrderShipped;
use App\Listeners\SendShipmentNotification;

protected $listen = [
    OrderShipped::class => [
        SendShipmentNotification::class,
    ],
];
```

---

## **6. Dispatching an Event**  

Events can be dispatched using the `event()` helper or directly:  

```php
use App\Events\OrderShipped;
use App\Models\Order;

$order = Order::find(1);
event(new OrderShipped($order));
```
OR  
```php
OrderShipped::dispatch($order);
```

---

## **7. Event Subscribers (Multiple Listeners for One Event)**  

Instead of defining listeners in `EventServiceProvider`, use a **subscriber**:  

### **Creating a Subscriber**  
```bash
php artisan make:listener OrderEventSubscriber
```
`app/Listeners/OrderEventSubscriber.php`  
```php
namespace App\Listeners;

use App\Events\OrderShipped;
use App\Events\OrderPlaced;

class OrderEventSubscriber
{
    public function handleOrderShipped(OrderShipped $event)
    {
        // Handle order shipped
    }

    public function handleOrderPlaced(OrderPlaced $event)
    {
        // Handle order placed
    }

    public function subscribe($events)
    {
        $events->listen(
            OrderShipped::class,
            [OrderEventSubscriber::class, 'handleOrderShipped']
        );

        $events->listen(
            OrderPlaced::class,
            [OrderEventSubscriber::class, 'handleOrderPlaced']
        );
    }
}
```

Register the subscriber in `EventServiceProvider.php`:  
```php
protected $subscribe = [
    \App\Listeners\OrderEventSubscriber::class,
];
```

---

## **8. Broadcasting Events (Real-time Notifications with WebSockets)**  

### **Installing Laravel Echo & Pusher**  
```bash
composer require pusher/pusher-php-server
npm install --save laravel-echo pusher-js
```

### **Configuring Pusher in `.env`**  
```env
BROADCAST_DRIVER=pusher
PUSHER_APP_ID=your_app_id
PUSHER_APP_KEY=your_app_key
PUSHER_APP_SECRET=your_app_secret
PUSHER_APP_CLUSTER=mt1
```

### **Defining a Broadcast Event**  
`app/Events/OrderShipped.php`  
```php
use Illuminate\Broadcasting\InteractsWithSockets;
use Illuminate\Contracts\Broadcasting\ShouldBroadcast;

class OrderShipped implements ShouldBroadcast
{
    use InteractsWithSockets;

    public $order;

    public function __construct(Order $order)
    {
        $this->order = $order;
    }

    public function broadcastOn()
    {
        return ['orders-channel'];
    }

    public function broadcastAs()
    {
        return 'order.shipped';
    }
}
```

### **Listening to Broadcasted Events in JavaScript**  
```javascript
import Echo from "laravel-echo";
window.Pusher = require("pusher-js");

window.Echo = new Echo({
    broadcaster: "pusher",
    key: "your_app_key",
    cluster: "mt1",
    forceTLS: true
});

window.Echo.channel("orders-channel")
    .listen(".order.shipped", (e) => {
        console.log("Order shipped:", e.order);
    });
```

---

## **9. Handling Failed Event Listeners**  

If an event listener fails, Laravel logs it in the `failed_jobs` table.  
To retry failed listeners:  
```bash
php artisan queue:retry all
```
To clear failed listeners:  
```bash
php artisan queue:flush
```

---

## **10. Event Throttling (Rate Limiting Event Execution)**  

Use `ShouldBeUnique` to ensure only one instance of an event runs at a time:  
```php
use Illuminate\Contracts\Queue\ShouldBeUnique;

class OrderShipped implements ShouldBeUnique
{
    // Unique event logic
}
```

---

## **11. Key Interview Questions on Events & Listeners**  

1. What are events and listeners in Laravel?  
2. How do you create and register an event and listener?  
3. What is the difference between `event()` and `dispatch()`?  
4. How do you queue event listeners in Laravel?  
5. How do you handle multiple listeners for a single event?  
6. What is the purpose of an event subscriber in Laravel?  
7. What is Laravel Echo, and how does it work with WebSockets?  
8. How do you handle failed events and listeners?  
9. What is the difference between **broadcast events** and **regular events**?  
10. How do you throttle event execution?  

---

# **ðŸ“Œ Laravel Events and Listeners - Explained**  

Laravelâ€™s event system allows decoupling different parts of your application by triggering and listening to events. This improves **code modularity** and **maintainability**.

---

## **1ï¸âƒ£ What are Events and Listeners in Laravel?**  
Events in Laravel allow **one part of the application** to notify **other parts** when something happens.

| **Component** | **Description** |
|--------------|----------------|
| **Event** | Represents an action that has occurred (e.g., `UserRegistered`, `OrderPlaced`). |
| **Listener** | Responds to the event and executes additional logic (e.g., sending an email, logging activity). |

âœ… **Example Use Case:**  
- When a user **registers**, send a **welcome email** (event: `UserRegistered`, listener: `SendWelcomeEmail`).  
- When an order is **placed**, update inventory and notify the admin (event: `OrderPlaced`, listeners: `UpdateInventory`, `NotifyAdmin`).

---

## **2ï¸âƒ£ How do you create and register an event and listener?**  
Laravel provides an **Artisan command** to generate events and listeners.

### **Step 1: Create an Event**  
```sh
php artisan make:event UserRegistered
```
This creates `app/Events/UserRegistered.php`:

```php
namespace App\Events;
use Illuminate\Foundation\Events\Dispatchable;

class UserRegistered {
    use Dispatchable;
    public $user;

    public function __construct($user) {
        $this->user = $user;
    }
}
```

---

### **Step 2: Create a Listener**  
```sh
php artisan make:listener SendWelcomeEmail --event=UserRegistered
```
This creates `app/Listeners/SendWelcomeEmail.php`:

```php
namespace App\Listeners;
use App\Events\UserRegistered;
use Mail;
use App\Mail\WelcomeMail;

class SendWelcomeEmail {
    public function handle(UserRegistered $event) {
        Mail::to($event->user->email)->send(new WelcomeMail($event->user));
    }
}
```

---

### **Step 3: Register the Event and Listener**  
Edit `app/Providers/EventServiceProvider.php`:

```php
protected $listen = [
    UserRegistered::class => [
        SendWelcomeEmail::class,
    ],
];
```

---

### **Step 4: Fire the Event**  
Call the event when a user registers:
```php
use App\Events\UserRegistered;

$user = User::create([...]);
event(new UserRegistered($user));
```

---

## **3ï¸âƒ£ What is the difference between `event()` and `dispatch()`?**  
| **Method** | **Usage** |
|------------|----------|
| `event()` | Triggers an event and executes listeners. |
| `dispatch()` | Used for **queued listeners**. Works for jobs and events. |

Example:
```php
event(new UserRegistered($user)); // Direct event triggering
dispatch(new UserRegistered($user)); // Queued event (if listener is queueable)
```

---

## **4ï¸âƒ£ How do you queue event listeners in Laravel?**  
To queue a listener, implement the `ShouldQueue` interface in the listener class:

```php
namespace App\Listeners;
use Illuminate\Contracts\Queue\ShouldQueue;

class SendWelcomeEmail implements ShouldQueue {
    public function handle(UserRegistered $event) {
        // Send email asynchronously
        Mail::to($event->user->email)->send(new WelcomeMail($event->user));
    }
}
```

ðŸš€ **Run Queue Worker:**  
```sh
php artisan queue:work
```

---

## **5ï¸âƒ£ How do you handle multiple listeners for a single event?**  
You can attach **multiple listeners** to the same event in `EventServiceProvider.php`:

```php
protected $listen = [
    UserRegistered::class => [
        SendWelcomeEmail::class,
        LogUserRegistration::class,
        NotifyAdmin::class,
    ],
];
```

âœ… **All three listeners will execute when `UserRegistered` is fired.**

---

## **6ï¸âƒ£ What is the purpose of an event subscriber in Laravel?**  
Event **subscribers** allow **handling multiple events in a single class**.

### **Example: Creating an Event Subscriber**
```sh
php artisan make:listener UserEventSubscriber
```
Modify `app/Listeners/UserEventSubscriber.php`:

```php
namespace App\Listeners;
use App\Events\UserRegistered;
use App\Events\UserDeleted;

class UserEventSubscriber {
    public function handleUserRegistered($event) {
        // Handle user registration
    }

    public function handleUserDeleted($event) {
        // Handle user deletion
    }

    public function subscribe($events) {
        $events->listen(
            UserRegistered::class,
            [UserEventSubscriber::class, 'handleUserRegistered']
        );

        $events->listen(
            UserDeleted::class,
            [UserEventSubscriber::class, 'handleUserDeleted']
        );
    }
}
```

### **Register Subscriber in `EventServiceProvider.php`**
```php
protected $subscribe = [
    UserEventSubscriber::class,
];
```

---

## **7ï¸âƒ£ What is Laravel Echo, and how does it work with WebSockets?**  
**Laravel Echo** is used for **real-time event broadcasting** with **WebSockets**.

### **Steps to Implement Laravel Echo**
1. **Install Laravel Echo & Socket.io**
   ```sh
   npm install --save laravel-echo socket.io-client
   ```

2. **Broadcast an Event**
   ```php
   class MessageSent implements ShouldBroadcast {
       public function __construct(public $message) {}

       public function broadcastOn() {
           return new Channel('chat');
       }
   }
   ```

3. **Listen for Event in JavaScript**
   ```js
   Echo.channel('chat')
       .listen('MessageSent', (event) => {
           console.log(event.message);
       });
   ```

âœ… **Used for** real-time notifications, chat applications, and live updates.

---

## **8ï¸âƒ£ How do you handle failed events and listeners?**  
When a **queued event listener** fails, Laravel moves it to the **failed_jobs** table.

### **Retry Failed Jobs**
```sh
php artisan queue:failed
php artisan queue:retry all
```

### **Manually Handle Failures in Listener**
```php
class SendWelcomeEmail implements ShouldQueue {
    public function failed(UserRegistered $event, $exception) {
        // Handle failure (e.g., log, send alert)
    }
}
```

---

## **9ï¸âƒ£ What is the difference between broadcast events and regular events?**  
| **Type** | **Use Case** | **How it Works** |
|----------|-------------|------------------|
| **Regular Events** | Application logic (e.g., logging, sending emails) | Runs on the backend without broadcasting. |
| **Broadcast Events** | Real-time updates (e.g., chat messages, notifications) | Sends event data via WebSockets. |

âœ… **Broadcast events require a WebSocket server (e.g., Laravel Echo, Pusher, Socket.io).**

---

## **ðŸ”Ÿ How do you throttle event execution?**  
Use **rate limiting** to prevent too many executions.

### **Example: Throttling Listeners**
Use `ThrottlesExceptions`:
```php
use Illuminate\Queue\InteractsWithQueue, Illuminate\Queue\ThrottlesExceptions;

class SendWelcomeEmail {
    use ThrottlesExceptions;

    public function handle(UserRegistered $event) {
        // Email logic
    }
}
```

### **Throttling in Job Dispatching**
```php
RateLimiter::attempt(
    'send-email:' . $user->id,
    5, // Maximum attempts
    function () use ($user) {
        dispatch(new SendWelcomeEmail($user));
    }
);
```

ðŸš€ **Throttling prevents excessive API calls or email spam.**

---

# **ðŸš€ Summary**
âœ” **Events** notify other parts of an application.  
âœ” **Listeners** respond to events (e.g., sending emails).  
âœ” **Queued listeners** improve performance.  
âœ” **Subscribers** group event listeners in a single class.  
âœ” **Broadcasting** sends events via WebSockets for real-time apps.  
âœ” **Throttling** prevents excessive executions.  

Let me know if you need more details! ðŸš€ðŸ”¥